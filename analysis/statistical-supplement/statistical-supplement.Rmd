---
title: "\\helveticaitalic{Supplementary Material}"
author: "Eva Koster et al."
output: 
  pdf_document:
    number_sections: true
    highlight: default
documentclass: frontiers-suppmat
classoption: utf8
bibliography: immune-reconst.bib
biblio-style: Frontiers-Vancouver
header-includes: 
  - \usepackage{url,hyperref,lineno,microtype}
  - \usepackage[onehalfspacing]{setspace}
  - \onecolumn
  - \firstpage{1}
---

```{r setup, include=FALSE}
# Knitr set-up
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(
  echo = FALSE, 
  out.width = "100%", 
  warning = FALSE, 
  message = FALSE
)

# Version control: https://github.com/hughjonesd/latexdiffr for latexdiffr

# Load libraries, set seed and theme
set.seed(8498456)
library(data.table)
library(targets)
library(ggplot2)

theme_set(theme_bw(base_size = 14))
```

<!-- Load targets objects -->

```{r load-objs}
tar_load(
  c(
    NMA_preDLI_datasets,
    dat_merged
  )
)
```

The present supplementary material is a `Statistical Supplement' to the main article, outlining the methods used and the motivation behind them.

# Research questions and data overview

<!-- Do just for CD4? Also use subsections -->

The two primary research questions addressed in the main article are

1. What is the effect of early low dose donor lymphocyte infusion (DLI) on the cell count kinetics within the T-cell compartment during the first 6 months after allogeneic stem cell transplantation (alloSCT)?

2. Are the T-cell kinetics from time of early low dose DLI associated with the risk of Graft-versus-Host-Disease (GvHD)?

To answer both questions, the data at hand are comprised of

- Baseline patient characteristics
- T-cell absolute counts measured routinely at discrete timepoints starting from time of alloSCT <!-- Add swimmer plot here -->
- Time of standard prophylactic DLI, and time of early low dose DLI (if given)
- Time to various clinical events occuring during follow-up, such as GvHD or relapse of the underlying disease

<!-- Do we want raw data overview here, maybe the swimmer plot -->

```{r test-swimmer, eval=FALSE}
dat_long <- NMA_preDLI_datasets$long
dat_wide <- NMA_preDLI_datasets$wide
dat_merged[TCD2 %in% c("NMA RD: ALT", "UD: ALT + ATG")]

# Prep endpoints 
dat_evs <- melt.data.table(
  data = dat_wide,
  id.vars = "IDAA",
  measure.vars = c("uDLI", "endpoint7"),
  variable.name = "event_id",
  value.name = "intSCT2_7"
)
dat_evs[intSCT2_7 > 6]

# Actually better to do this with raw data

# See https://ggplot2-book.org/facet.html
dat_long |> 
  ggplot(aes(x = intSCT2_7, y = reorder(IDAA, endpoint7))) +
  geom_line(aes(group = IDAA), linetype = "dotted", alpha = 0.5) +
  geom_point() +
  facet_grid(
    endpoint7_s ~ ., 
    #labeller = labeller(endpoint5_s = event_labs),
    scales = "free_y",
    space = "free"
  ) +
  labs(x = "Time since alloHCT (months)", y = "Patient ID") + 
  theme_light(base_size = 14) +
  theme(
    legend.position = "none",
    axis.text.y = element_blank(), 
    panel.grid.major.y = element_blank()
  ) 
```

Explanation here of `dropout', the kind of cohort, issue with mixed models..

## Question 1: effect of early low dose DLI on cell count kinetics

<Naive approaches, descriptives, dividing based on endpoint
Linear models, mixed models, Rouanet paper, defining a population
Choices to make in joint model, additional complexity with each extra competing risk
Inadequate sample size, baseline hazard complexity, optimisation complexity
Needing a survival model even though not necessarily interested in survival> 

[Write some stuff here, organise placeholders for plots, divide stuff up later, find references in Zotero]

## Pre-DLI model

Example references @rizopoulosJointModelsLongitudinal2012

$D = \{0, 1, 2, 3\}$ where 0 = *censored*, 1 = *GvHD*, 2 = *Relapse* and 3 = *Other failures*.

\begin{align*}
  h_{1i}(t) &= h_{10}(t) \exp\big\{\gamma_{11}\text{UD}_i + \gamma_{12}\text{ITT}_i + \alpha_1 m_i(t) \big\} \\ 
  h_{2i}(t) &= h_{20}(t) \exp\big\{\gamma_{21}\text{UD}_i + \gamma_{22}\text{ITT}_i + \alpha_2 m_i(t) \big\} \\
  h_{3i}(t) &= h_{30}(t) \exp\big\{\gamma_{31}\text{UD}_i + \alpha_3 m_i(t) \big\}
\end{align*}

For longitudinal we assume $y_i(t) = m_i(t) + \epsilon_i(t)$, where


\begin{align*}
  m_i(t) &= \beta_0 + (\beta_1 + b_{i1})B_n(t,\lambda_1) + (\beta_2 + b_{i2})B_n(t,\lambda_2) + (\beta_3 + b_{i3})B_n(t,\lambda_3) + \\
  & \beta_4 \{B_n(t,\lambda_1) \times \text{ITT}_i \} + \beta_5 \{B_n(t,\lambda_2) \times \text{ITT}_i \} + \beta_6 \{B_n(t,\lambda_3) \times \text{ITT}_i \} + \\
  & \beta_7 \{B_n(t,\lambda_1) \times \text{UD}_i \} + \beta_8 \{B_n(t,\lambda_2) \times \text{UD}_i \} + \beta_9 \{B_n(t,\lambda_3) \times \text{UD}_i \} + \\
  & \beta_{10} \{B_n(t,\lambda_1) \times \text{ITT}_i \times \text{UD}_i \} + \beta_{11} \{B_n(t,\lambda_2) \times \text{ITT}_i \times \text{UD}_i \} \\
  & \beta_{12} \{B_n(t,\lambda_3) \times \text{ITT}_i \times \text{UD}_i \} + \\
  & \beta_{13}\text{CMV}_i + \beta_{14}\text{ITT}_i + \beta_{15}\text{UD}_i + \beta_{16} \{\text{ITT}_i \times \text{UD}_i\}
\end{align*}

Attempt at more concise:

\begin{align*}
  m_i(t) &= \beta_0 + \sum_{q=1}^3(\beta_q + b_{iq})B_n(t,\lambda_q)  + \sum_{q=1}^3 \beta_{q + 3}\{B_n(t,\lambda_q) \times \text{ITT}_i\} + \sum_{q=1}^3 \beta_{q + 6}\{B_n(t,\lambda_q) \times \text{UD}_i\} + \\
  & \sum_{q=1}^3 \beta_{q + 9}\{B_n(t,\lambda_q) \times \text{ITT}_i \times \text{UD}_i\} + \beta_{13}\text{CMV}_i + \beta_{14}\text{ITT}_i + \beta_{15}\text{UD}_i + \beta_{16} \{\text{ITT}_i \times \text{UD}_i\}
\end{align*}


## Post-DLI model

$D = \{0, 1, 2\}$ where 0 = *censored*, 1 = *GvHD*, 2 = *Relapse or other failures*.

\begin{align*}
  h_{1i}(t) &= h_{10}(t) \exp\big\{\gamma_{11}\text{EarlyDLI}_i + \alpha_1 m_i(t) \big\} \\ 
  h_{2i}(t) &= h_{20}(t) \exp\big\{\alpha_2 m_i(t) \big\}
\end{align*}

And longitudinal 

\begin{align*}
  m_i(t) &= (\beta_0 + b_{i0}) + \sum_{q=1}^2(\beta_q + b_{iq})B_n(t,\lambda_q)  + \sum_{q=1}^2 \beta_{q + 2}\{B_n(t,\lambda_q) \times \text{EarlyDLI}_i\} + \beta_{15}\text{UD}_i 
\end{align*}

## Subsection


## Subsubting

Illustration of slope

Test code snippet

```{r test-snip, echo=TRUE, eval=FALSE}
jointModel(
  lmeObject = preDLI_long_corr_CD3,
  survObject = preDLI_cox,
  CompRisk = TRUE,
  method = "spline-PH-aGH",
  timeVar = "intSCT2_7",
  parameterization = "value",
  interFact = list("value" = ~ strata(trans) - 1),
  iter.qN = 1000,
  lng.in.kn = preDLI_basehaz_knots,
  numeriDeriv = "cd",
  eps.Hes = 1e-04
)
```

## Software choices

Reference to Hickey review?

## To-do

- Residual plots
- Notation for mixed and survival submodels, pre and post-DLI
- tbd

# References
